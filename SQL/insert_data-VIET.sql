-- Tạo MASTER KEY 

IF NOT EXISTS ( 

    SELECT *  

FROM sys.symmetric_keys  

WHERE symmetric_key_id = 101 

) 

BEGIN 

    CREATE MASTER KEY ENCRYPTION BY PASSWORD = '22120429'; 

END; 

GO 

 

-- Tạo CERTIFICATE 

IF NOT EXISTS ( 

    SELECT *  

FROM sys.certificates  

WHERE name = 'MYCERTIFICATE' 

) 

BEGIN 

    CREATE CERTIFICATE MYCERTT  

WITH SUBJECT = 'Certificate use for create asymmetric key'; 

END; 

GO 

 

-- Tạo ASYMMETRIC KEY 

IF NOT EXISTS ( 

    SELECT *  

FROM sys.asymmetric_keys  

WHERE name = 'AsymKey_NhanVien' 

) 

BEGIN 

    CREATE ASYMMETRIC KEY AsymKey_NhanVien 

    WITH ALGORITHM = RSA_2048 

    ENCRYPTION BY PASSWORD = '22120429'; 

END; 

GO 

 

-- SP: SP_INS_PUBLIC_NHANVIEN 

CREATE PROCEDURE SP_INS_PUBLIC_NHANVIEN 

    @MANV VARCHAR(20), 

    @HOTEN NVARCHAR(100), 

    @EMAIL VARCHAR(20), 

    @LUONGCB VARCHAR(100), 

    @TENDN NVARCHAR(100), 

    @MK NVARCHAR(100) 

AS 

BEGIN 

    SET NOCOUNT ON; 

 

    -- Mã hóa mật khẩu bằng SHA1 

    DECLARE @MATKHAU VARBINARY(MAX) = HASHBYTES('SHA1', @MK); 

 

    -- Mã hóa lương bằng RSA thông qua ASYMMETRIC KEY 

    DECLARE @ASYM_KEY_ID INT = AsymKey_ID('AsymKey_NhanVien'); 

    DECLARE @LUONG_ENC VARBINARY(MAX) = EncryptByAsymKey(@ASYM_KEY_ID, CONVERT(VARBINARY(MAX), @LUONGCB)); 

 

    DECLARE @PUBKEY VARCHAR(20) = @MANV; 

 

    INSERT INTO NHANVIEN (MANV, HOTEN, EMAIL, LUONG, TENDN, MATKHAU, PUBKEY) 

    VALUES (@MANV, @HOTEN, @EMAIL, @LUONG_ENC, @TENDN, @MATKHAU, @PUBKEY); 

END; 

GO 